<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الاستقبال - مركز قفار الصحي</title>
  <link rel="stylesheet" href="style.css">


  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="config.js"></script>




  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>

   <script>
function toggleSidebar() {
  document.getElementById("sidebar").classList.toggle("open"); }
</script>


<script>
// يمنع F12 + كليك يمين + Ctrl+U + Ctrl+Shift+I
document.addEventListener('keydown', function(e) {
  if (e.keyCode == 123 || 
      (e.ctrlKey && e.shiftKey && e.keyCode == 73) || 
      (e.ctrlKey && e.keyCode == 85)) {
    e.preventDefault();
    return false;
  }
});
document.addEventListener('contextmenu', e => e.preventDefault());
</script>


</head>
<body>

<script>
  firebase.auth().onAuthStateChanged((user) => {
    if (!user) {
      window.location.href = 'login.html';  // يرجع لصفحة الدخول لو مش مسجل
    }
  });
</script>








  <!-- Sidebar مع زر فتح/إغلاق -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>مركز قفار الصحي</h3>
      <button class="toggle-btn" onclick="toggleSidebar()">X</button>
    </div>
    <div class="nav">
      <a href="home.html">الرئيسية</a>
      <a href="reception.html">الاستقبال</a>
      <a href="nurse.html">لوحة التمريض</a>
      <a href="display.html">شاشة العرض</a>
      <a href="admin.html" style="background:#0d47a1;">لوحة الإدارة</a>
      <a href="#" onclick="logout()" style="background:#d32f2f;color:white;">تسجيل الخروج</a>
    </div>
  </div>
  <div class="open-btn" onclick="toggleSidebar()">☰</div>

<!-- زر الفتح من الخارج (يظهر لما الـ Sidebar مقفل) -->
<div class="open-btn" onclick="toggleSidebar()">☰</div>

  <div class="container">
    <h1>الاستقبال - مركز قفار الصحي</h1>
    <p style="font-size:32px;margin-bottom:30px;">نظام أرقام انتظار المختبر</p>

    <!-- الحقل: أرقام فقط + 10 أرقام بالضبط -->
    <input type="text" 
           id="idNumber" 
           placeholder="رقم الهوية الوطنية " 
           maxlength="10" 
           inputmode="numeric"
           pattern="[0-9]*"
           autofocus
           style="font-size:28px;letter-spacing:8px;text-align:center;">

    <button onclick="issueTicket()">إصدار رقم الانتظار</button>

    <!-- النتيجة -->
    <div id="result" class="hidden" style="margin-top:40px;">
      <div style="background:#e8f5e8;padding:40px;border-radius:25px;">
        <h2 style="color:#1565c0;font-size:40px;">تم إصدار رقم الانتظار بنجاح</h2>
        
        <div style="margin:30px 0;">
          <p style="font-size:38px;">رقم الانتظار اليوم</p>
          <div class="big-number" id="ticketNumber">001</div>
        </div>

        <div style="background:white;padding:25px;border-radius:20px;margin:20px 0;font-size:32px;">
          <strong>رقم الهوية:</strong> <span id="patientId">1234567890</span>
        </div>
        <div style="background:#fff3e0;padding:25px;border-radius:20px;font-size:32px;">
  <strong>ترتيبك في الطابور:</strong> 
  <span style="color:#d32f2f;font-size:40px;" id="position">يحسب...</span>
</div>
      </div>
    </div>
  </div>

<script>
// منع إدخال أي شيء غير الأرقام + حذف فوري
document.getElementById("idNumber").addEventListener("input", function() {
  this.value = this.value.replace(/[^0-9]/g, ''); // يحذف أي شيء غير رقم فورًا
});

async function issueTicket() {
  const input = document.getElementById("idNumber");
  const id = input.value.trim();

  // تحقق من أن الرقم 10 أرقام بالضبط
  if (id.length !== 10) {
    alert("يرجى إدخال رقم هوية صحيح (10 أرقام بالضبط)");
    input.focus();
    return;
  }

  const today = new Date().toISOString().slice(0,10);
  const counterRef = db.collection("counter").doc(today);

  try {
    const counterSnap = await counterRef.get();
    let nextNum = counterSnap.exists ? counterSnap.data().current + 1 : 1;

    // تحقق إذا أخذ رقم اليوم
    const existing = await db.collection("queue")
      .where("nationalId", "==", id)
      .where("date", "==", today)
      .get();

    if (!existing.empty) {
      const old = existing.docs[0].data();
      showResult(old.number, id);
      return;
    }

    await counterRef.set({ current: nextNum, date: today }, { merge: true });
    
    await db.collection("queue").add({
      number: nextNum,
      nationalId: id,
      date: today,
      timestamp: new Date(),
      status: "waiting"
    });

    await db.collection("patients").doc(id).collection("visits").add({
      number: nextNum,
      date: today,
      time: new Date().toLocaleTimeString('ar-SA'),
      timestamp: new Date()
    });

    showResult(nextNum, id);

  } catch (e) {
    alert("حدث خطأ، حاول مرة أخرى");
  }
}

function showResult(number, id) {
  document.getElementById("ticketNumber").textContent = number.toString().padStart(3,'0');
  document.getElementById("patientId").textContent = id;
  document.getElementById("result").classList.remove("hidden");

  // حساب الترتيب الصحيح بدون أي index ولا مشكلة
  const today = new Date().toISOString().slice(0,10);
  db.collection("queue")
    .where("date", "==", today)
    .where("status", "==", "waiting")
    .get()
    .then(snap => {
      let position = 0;
      snap.forEach(doc => {
        if (doc.data().number <= number) position++;
      });
      const text = position === 1 ? "أنت الأول في الانتظار" : `يوجد ${position - 1} أشخاص قبلك`;
      document.getElementById("position").textContent = text;
    })
    .catch(err => {
      document.getElementById("position").textContent = "خطأ في الحساب";
    });
}
</script>




<script>
  const auth = firebase.auth();
  auth.onAuthStateChanged(user => { if (!user) location.href = "login.html"; });
  function logout() { auth.signOut().then(() => location.href = "login.html"); }
</script>


<script>
// دالة الخروج + حماية الصفحة
function logout() {
  firebase.auth().signOut().then(() => {
    window.location.href = "login.html";
  }).catch(() => {
    window.location.href = "login.html";
  });
}

// لو المستخدم مش مسجل دخوله → يرجع للـ login فورًا
firebase.auth().onAuthStateChanged((user) => {
  if (!user) {
    window.location.href = "login.html";
  }
});
</script>

</body>
</html>